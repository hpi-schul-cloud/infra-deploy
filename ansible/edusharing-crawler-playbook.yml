---
- name: Deploy to Edusharing Clusters
  hosts:
    - edusharing
  connection: local
  roles:
    - kubeconfig
  tasks:
  - name: Add Helm Chart Repo
    kubernetes.core.helm_repository:
      name: dbildungscloud
      repo_url: "https://hpi-schul-cloud.github.io/helm-charts/"

  - name: Install Crawler for Edusharing
    kubernetes.core.helm:
      name: "crawler-{{ item.crawler.name}}"
      chart_ref: "dbildungscloud/edusharing-crawler"
      update_repo_cache: yes
      wait: yes
      chart_version: "{{ edusharing_crawler_helm_chart_version }}"
      kubeconfig: "{{ kubeconfig }}"
      release_namespace: "{{ namespace }}"
      values:
        "{{ item.values }}"
    when: item.values.crawler.enabled
    loop: "{{ edusharing_crawler_list }}"
